<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>File Viewer</title>
<script src="../assets/pdf.worker.js"></script>
<script src="../assets/jspdf.min.js"></script>
<script src="../assets/html2canvas.min.js"></script>
<script src="../assets/xlsx.full.min.js"></script>
<script src="../assets/qrious.min.js"></script>
<script src="../assets/jsQR.min.js"></script>

<style>
body { font-family: Arial; padding: 20px; background: #f5f5f5; }
.container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px #ccc; }
canvas, table, img { margin-top: 20px; border: 1px solid #ccc; }
h2 { margin-bottom: 10px; }
</style>
</head>
<body>
<div class="container">
<h2>File Preview</h2>
<div id="viewerContent"></div>
</div>

<script>
function getQueryParams() {
    let params = {};
    location.search.substring(1).split("&").forEach(pair => {
        let [key, value] = pair.split("=");
        params[key] = decodeURIComponent(value);
    });
    return params;
}

window.onload = async function() {
    const params = getQueryParams();
    const contentDiv = document.getElementById("viewerContent");

    if(params.file) {
        const fileURL = params.file;

        // PDF Viewer
        if(fileURL.endsWith(".pdf")) {
            const loadingTask = pdfjsLib.getDocument(fileURL);
            const pdf = await loadingTask.promise;
            for(let i=1;i<=pdf.numPages;i++){
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({scale:1.5});
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({canvasContext: ctx, viewport}).promise;
                contentDiv.appendChild(canvas);

                // Apply watermark or rotation if passed
                if(params.wm && i==1){
                    ctx.font="40px Arial";
                    ctx.fillStyle=`rgba(150,150,150,${params.op||0.3})`;
                    ctx.fillText(params.wm,30,150);
                }
                if(params.rotate){
                    // rotation handled in main tool, viewer just shows canvas
                }
            }
        }

        // QR Code Viewer
        else if(params.qr){
            const canvas = document.createElement("canvas");
            const qr = new QRious({element:canvas,size:250,value:params.qr});
            contentDiv.appendChild(canvas);
        }

        // Excel Viewer (preview)
        else if(fileURL.endsWith(".xlsx") || fileURL.endsWith(".xls")){
            const response = await fetch(fileURL);
            const data = await response.arrayBuffer();
            const workbook = XLSX.read(data);
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const html = XLSX.utils.sheet_to_html(sheet);
            contentDiv.innerHTML = html;
        }

        // Image Viewer
        else if(fileURL.match(/\.(jpg|jpeg|png|gif)$/i)){
            const img = document.createElement("img");
            img.src = fileURL;
            img.style.maxWidth="100%";
            contentDiv.appendChild(img);
        }

        // HTML Viewer
        else if(params.html){
            contentDiv.innerHTML = decodeURIComponent(params.html);
        }
    }
};
</script>

</body>
</html>
