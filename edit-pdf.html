<!DOCTYPE html>
<html>
<head>
    <title>Edit PDF</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.5.207/pdf.min.js"></script>

    <!-- jsPDF -->
    <script src="../assets/jspdf.min.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; }
        canvas { border: 1px solid #000; margin-top: 20px; }
        .btn { padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; margin: 5px; }
        #textInput { width: 200px; padding: 5px; }
    </style>
</head>
<body>

<h2>Edit PDF (Add Text + Draw)</h2>

<input type="file" id="pdfUpload" accept="application/pdf"><br><br>
<button class="btn" onclick="loadPDF()">Load & View PDF</button>

<h3>Tools:</h3>
<input type="text" id="textInput" placeholder="Enter text">
<button class="btn" onclick="enableText()">Add Text</button>
<button class="btn" onclick="enableDraw()">Draw</button>
<button class="btn" onclick="saveEditedPDF()">Download Edited PDF</button>

<br><br>
<canvas id="pdfCanvas"></canvas>

<script>
let pdfDoc = null;
let pageRendering = false;
let canvas = document.getElementById("pdfCanvas");
let ctx = canvas.getContext("2d");
let isDrawing = false;
let drawMode = false;
let textMode = false;

/* ---------------- LOAD PDF ---------------- */
async function loadPDF() {
    let file = document.getElementById("pdfUpload").files[0];
    if (!file) return alert("Select PDF!");

    let fileReader = new FileReader();
    fileReader.onload = async function() {
        let typedarray = new Uint8Array(this.result);
        pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
        renderPage(1);
    };
    fileReader.readAsArrayBuffer(file);
}

/* ---------------- RENDER FIRST PAGE ---------------- */
async function renderPage(num) {
    pageRendering = true;
    let page = await pdfDoc.getPage(num);

    let viewport = page.getViewport({ scale: 1.4 });
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    let renderContext = {
        canvasContext: ctx,
        viewport: viewport
    };

    await page.render(renderContext).promise;

    pageRendering = false;
}

/* ---------------- ENABLE TEXT MODE ---------------- */
function enableText() {
    textMode = true;
    drawMode = false;
    alert("Click on canvas to add text.");
}

/* ---------------- ENABLE DRAW MODE ---------------- */
function enableDraw() {
    drawMode = true;
    textMode = false;
}

/* ---------------- HANDLE CANVAS CLICKS ---------------- */
canvas.addEventListener("click", function(e) {
    if (!textMode) return;

    let text = document.getElementById("textInput").value;
    if (!text) return;

    let rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;

    ctx.font = "20px Arial";
    ctx.fillStyle = "red";
    ctx.fillText(text, x, y);
});

/* ---------------- DRAWING TOOL ---------------- */
canvas.addEventListener("mousedown", function() {
    if (!drawMode) return;
    isDrawing = true;
});

canvas.addEventListener("mouseup", () => isDrawing = false);

canvas.addEventListener("mousemove", function(e) {
    if (!drawMode || !isDrawing) return;

    let rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;

    ctx.fillStyle = "blue";
    ctx.fillRect(x, y, 4, 4);
});

/* ---------------- SAVE EDITED PDF ---------------- */
function saveEditedPDF() {
    const pdf = new jspdf.jsPDF("p", "mm", "a4");

    let imgData = canvas.toDataURL("image/png");

    let width = pdf.internal.pageSize.getWidth();
    let height = (canvas.height / canvas.width) * width;

    pdf.addImage(imgData, "PNG", 0, 0, width, height);

    pdf.save("Edited_PDF.pdf");
}
</script>

</body>
</html>
